<script>

// getUsageCookieValue reads the cookies_policy cookie and returns the value a user has set for usage, 
// or defaults to true to opt_out of usage cookie if no cookie is set, or theres an error getting the value
function getUsageCookieValue() {
    // TODO: this is the legacy cookie (cookies_policy) handling and will be removed in due course
    var legacyPolicyCookie = document.cookie.match('(^|;) ?cookies_policy=([^;]*)(;|$)');
    if (legacyPolicyCookie) {
        console.debug('legacy cookies_policy found')
        var decodedCookie = decodeURIComponent(legacyPolicyCookie[2])
        var cookieValue = JSON.parse(decodedCookie)
        console.debug('usage is', cookieValue.usage)
        return !cookieValue.usage
    }

    // ons_cookie_policy handler
    var policyCookie = document.cookie.match(/^(.*)?\s*'usage':true\s*[^;]+(.*)?$/);
    if (policyCookie) {
        console.debug('ons_cookie_policy found - opting in')
        // this needs to be the inverse - if usage is true the returned value is false and vice versa
        // user is stating whether they are opting out of usage cookie
        return false
    }
    console.debug('no cookie found - opting out')
    return true
}

// unescape html entities
function htmlUnescape(str){
    return str.replace(/&#x3D;/g, "=");
}

dataLayer = [{
    "analyticsOptOut": getUsageCookieValue(),
    "gtm.whitelist": ["google","hjtc","lcl"],
    "gtm.blacklist": ["customScripts","sp","adm","awct","k","d","j"],
    {{if .DatasetTitle }}
        "contentTitle": htmlUnescape({{.DatasetTitle}}),
        "filterTitle": htmlUnescape({{.Metadata.Title}}),
    {{else}}
        "contentTitle": htmlUnescape({{.Metadata.Title}}),
    {{end}}
    {{if .ReleaseDate }}
        "releaseDate": {{dateFormatYYYYMMDD .ReleaseDate}},
    {{end}}
    {{ if eq .Type "search" }}
        "numberOfResults": {{.Count}},
        "resultsPage": {{.Pagination.CurrentPage}},
    {{ end }}
    {{ if .ABTest.GTMKey }}
        "abTest": {{ .ABTest.GTMKey }},
    {{ end }}
    {{ if .Type }}
        "contentType": {{ .Type }},
    {{ end }}
    {{ if .DatasetId }}
        "datasetID": {{ .DatasetId }},
    {{ end }}
}];

</script>
